<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>

    <title>Регистрация | sYnask</title>
    <style>
        body {
            background-color: rgb(0, 0, 0);
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;

        }

        .left-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .right-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .title {
            font-size: 60px; /* Увеличил размер шрифта */
            color: orange;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 20px; /* Добавил отступ сверху */
        }

        .img_v {
            width: 10px;
            height: 10px;
            background: url(select_icon.png);
            background-position: center;
        }

        .description {
            font-size: 16px;
            color: white;
            text-align: left;
            margin-bottom: 20px;
        }

        .user-count {
            font-size: 30px;
            color: orange;
            text-align: left;
            text-transform: uppercase;
            margin-top: -12px;
            margin-left: 15px;
            margin-bottom: -5px;
        }

        .paragraph {
            margin-top: 35px;
            margin-right: 8px;
            margin-left: 12px;
        }

        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #0b0012;
            border-radius: 35px;
            border: 1px solid #ffa300;
            max-width: 400px;
            width: 100%;
            margin-top: 80px;
        }

        #turnstile-container {
            margin-top: 20px;
        }

        .form-title {
            font-size: 24px;
            color: white;
            margin-bottom: 10px;
            font-family: Arial, sans-serif;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: bold;
            text-align: center;
        }

        .form-subtitle {
            font-size: 16px;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }

        input[type="text"],
        input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid orange;
            border-radius: 5px;
            background-color: #283040;
            color: white;
            font-size: 16px;
            max-width: 400px;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }


        .login-form button[type="button"] {
            padding: 10px 20px;
            background-color: orange;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .login-form button[type="button"]:hover {
            background-color: #ff8b3d;
        }

        .forgot-password {
            color: orange;
            text-decoration: none;
            margin-bottom: 20px;
            display: block; /* Сделал ссылку блочным элементом */
        }

        .password-container {
            position: relative;
            width: 100%;
        }

        .eye-icon {
            position: absolute;
            top: 37%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #ccc;
            font-size: 25px;
        }

        .eye-icon:hover {
            color: #666;
        }

        .header-line {
            width: 50px;
            height: 3px;
            background-color: #FFA500;
            border-radius: 50px;
            margin: 0 auto 10px;
        }

        .messenger-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .popup-container {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000000;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            opacity: 0;
            transition: top 0.5s ease, opacity 0.5s ease;
            z-index: 5;
        }

        .popup-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .popup-text {
            font-size: 14px;
            color: white;
        }

        .popup-image {
            max-width: 30px;
            max-height: 30px;
        }

        .text-back-profile {
            text-align: center;
            margin-top: 20px;
            font-size: 15px;
            color: #FFA500;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
        }

        .profile-button {
            background-color: #2b2b2b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s ease;
        }

        .profile-button:hover {
            background-color: #FF8300;
        }

        .discord-avatar {
            width: 30px;
            height: 30px;
            border-radius: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .email-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }
        #no-account-message {
            font-size: 14px;
            color: white;
            margin-top: 10px;
        }

        @media screen and (max-width: 900px) {
            .container {
                flex-direction: column; /* Переносим элементы в колонку */
                align-items: center; /* Центрируем элементы по центру */
            }

            .left-side {
                order: -1; /* Переносим левую сторону вверх */
                margin-bottom: 20px; /* Добавляем отступ снизу */
            }

            .right-side {
                order: 1; /* Переносим форму входа вниз */
            }

            .login-form {
                width: 400px; /* Уменьшаем ширину формы входа */
                padding: 15px; /* Уменьшаем отступы внутри формы */
            }

            .footer {
                margin-top: 600px;
            }
        }

        @media screen and (max-width: 450px) {
            .login-form {
                width: 350px;
                padding: 15px;
            }
        }

        @media screen and (max-width: 300px) {
            .login-form {
                width: 200px;
                padding: 10px;
            }
        }

        #register-button:hover {
            background-color: #45a049;
        }

        .password-strength {
            margin-top: 20px;
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .strength-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .password-hints {
            color: #777;
        }

        .button-discord {
            background-color: #7289DA; /* Цвет Discord */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s ease;
            margin-left: 18%;
            margin: 0 auto 20px;
        }

        .button-discord:hover {
            background-color: #5865F2;
        }

        .select-container {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }
        .select-container select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-left: 30px;
            padding-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-image: url('https://flagpedia.net/data/flags/w1160/ru.png');
            background-size: 20px;
            background-repeat: no-repeat;
            background-position: 5px center;
            background-color: #fff;
            cursor: pointer;
        }
        /* Стили для номера телефона */
        .phone-input {
            width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #2c2c2c;
            margin: 7% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
        }

        .input-container {
            position: relative;
            margin-bottom: 15px;
            width: 90%;
        }

        .input-container input, .input-container select {
            width: calc(100% - 30px);
            padding: 10px;
            border: 2px solid orange;
            border-radius: 5px;
            background-color: #283040;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 0px;
        }

        .input-container .nickname-container {
            display: flex;
        }

        .input-container .nickname-container input {
            flex: 1;
        }

        .input-container .help-icon {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-55%);
            cursor: pointer;
            color: white;
        }

        .full-width input,
        .full-width select {
            width: 100%;
            appearance: none;
        }

        /* Loader Styles */
        .loader-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9;
        }

        .loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
        }

        .loader .spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #ff7f00;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            background-color: #000;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #fff;
        }
        .footer a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="right-side">
            <form class="login-form" id="loginForm">
                <div class="form-title">Регистрация</div>
                <div class="form-subtitle">уникального аккаунта sYn</div>
                <input type="text" id="phone-num" name="phone" placeholder="Ваш номер телефона">
                <input type="text" id="email" name="email" placeholder="Ваш Email-адрес">
                <div class="password-container">
                    <input type="password" id="password" name="password" placeholder="Придумайте пароль" autocomplete="new-password" onkeyup="this.value = this.value.replace(/ /g, '')">
                    <span class="eye-icon" id="eyeIcon1" onclick="togglePasswordVisibility()">&#128065;</span>
                </div>
                <div class="password-container">
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Подтвердите пароль" autocomplete="new-password" onkeyup="this.value = this.value.replace(/ /g, '')">
                    <span class="eye-icon" id="eyeIcon2" onclick="togglePasswordVisibility()">&#128065;</span>
                </div>
                <div class="password-hints" id="passwordHints"></div>
                <div class="password-strength">
                    <div id="passwordStrength" class="strength-bar"></div>
                </div>
                <p style="font-size: 10px;">Регистрируя аккаунт, вы соглашаетесь с условиями <a href="/privacy-policy" style="color: orange;" class="privacy-link" target="_blank">Политики Конфиденциальности</a>.</p>
                <div id="turnstile-container"></div>
                <button type="button" id="registration" onclick="register()" disabled>Продолжить</button>
            </form>
        </div>
    </div>
    <div id="profileModal" class="modal">
        <div class="modal-content"></div>
    </div>

    <div id="loader-background" class="loader-background"></div>
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p>Загрузка...</p>
    </div>

    <footer class="footer">
        <nav class="menu">
            <a style="color: violet;" href="https://syprod.ru/">sYprod company</a>
            <a href="https://syprod.ru/">О компании</a>
            <a href="#">Продукты</a>
            <a style="color: orange;" href="/login">Вход</a>
            <a style="color: orange;" href="/registration">Регистрация</a>
            <a href="#">FAQ</a>
            <a href="#">Контакты</a>
        </nav>
    </footer>

    <script>
        // ФУНКЦИИ: ВИЗУАЛЬНАЯ СОСТАВЛЯЮЩАЯ

        // ПОКАЗЫВАЕТ УВЕДОМЛЕНИЕ С ТЕКСТОМ И КАРТИНКОЙ
        let currentPopup = null;

        function showPopupWithImageAndText(message, imagePath, displayTime) {
            if (currentPopup) {
                currentPopup.remove(); // Удаляем предыдущее уведомление, если оно есть
            }

            const popupContainer = document.createElement('div');
            popupContainer.className = 'popup-container';

            const popupContent = document.createElement('div');
            popupContent.className = 'popup-content';

            const popupImage = document.createElement('img');
            popupImage.src = imagePath;
            popupImage.alt = 'Изображение';
            popupImage.className = 'popup-image';

            const popupText = document.createElement('span');
            popupText.className = 'popup-text';
            popupText.textContent = message;

            popupContent.appendChild(popupImage);
            popupContent.appendChild(popupText);

            popupContainer.appendChild(popupContent);
            document.body.appendChild(popupContainer);

            setTimeout(() => {
                popupContainer.style.top = '50px';
                popupContainer.style.opacity = '1';
            }, 500);

            setTimeout(() => {
                popupContainer.style.top = '-100px';
                popupContainer.style.opacity = '0';
            }, displayTime);

            currentPopup = popupContainer; // Сохраняем ссылку на текущее уведомление
        }

        // ФУНКЦИИ ВИЗУАЛЬНОЙ АНИМАЦИИ ЗАГРУЗКИ

        function showLoader() {
            document.getElementById('loader-background').style.display = 'block';
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader-background').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
        }

        // Функции автозаполнения поля почты из URL

        window.addEventListener('DOMContentLoaded', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var email = urlParams.get('email');

            if (email) {
              document.getElementById('email').value = email;
            }
        });

        // ФУНКЦИИ: Важнейшее

        // Инициализация капчи с анимацией загрузки

        async function renderCaptcha() {
            showLoader();
            try {
                widgetId = await new Promise((resolve, reject) => {
                    turnstile.render('#turnstile-container', {
                        sitekey: '0x4AAAAAAAb6BKl1y6rR8dGk',
                        callback: function(token) {
                            captchaToken = token;
                            resolve(widgetId);
                        },
                        'error-callback': function() {
                            showPopupWithImageAndText('Ошибка загрузки капчи. Пожалуйста, перезагрузите страницу и попробуйте снова.', 'https://imgur.com/aHcCPrp.jpg', 5000);
                            reject(new Error('Ошибка загрузки капчи'));
                        }
                    });
                });
            } catch (error) {
                console.error(error);
            } finally {
                hideLoader();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            renderCaptcha();
        });

        // Функция для форматирования номера телефона при вводе

        function formatPhoneNumber() {
            var phoneNumber = document.getElementById('phone-num').value;
            phoneNumber = phoneNumber.replace(/[^\d]/g, ''); // Удаление всех символов, кроме цифр
            var formattedPhoneNumber = '';
            // Форматирование номера телефона согласно общепринятому формату
            if (phoneNumber.length > 0) {
                formattedPhoneNumber = '+' + phoneNumber.slice(0, 1) + ' ';
                if (phoneNumber.length > 1) {
                    formattedPhoneNumber += phoneNumber.slice(1, 4) + ' ';
                }
                if (phoneNumber.length > 4) {
                    formattedPhoneNumber += phoneNumber.slice(4, 7) + ' ';
                }
                if (phoneNumber.length > 7) {
                    formattedPhoneNumber += phoneNumber.slice(7);
                }
            }
            document.getElementById('phone-num').value = formattedPhoneNumber;
        }

        document.getElementById('phone-num').addEventListener('input', formatPhoneNumber);

        // Переменные

        const urlParams = new URLSearchParams(window.location.search);

        var phone;
        var email;
        var password;
        var isEmailUsed;
        var isPhoneUsed;
        var captchaToken = '';
        var phoneInput;
        var emailInput;
        var passwordInput;
        var confirmPasswordInput;
        var registrationButton;
        var saveButton;
        let typingTimer;

        document.addEventListener('DOMContentLoaded', function() {
            phoneInput = document.getElementById('phone-num');
            emailInput = document.getElementById('email');
            passwordInput = document.getElementById('password');
            confirmPasswordInput = document.getElementById('confirmPassword');
            registrationButton = document.getElementById('registration');
            saveButton = document.getElementById('saveAccount');

        });

        // Инициализация Supa

        const { createClient } = supabase;
        const supabaseClient = createClient('https://cnicyffiqvdhgyzkogtl.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuaWN5ZmZpcXZkaGd5emtvZ3RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDc3NDM2NzcsImV4cCI6MjAyMzMxOTY3N30.bZoapdV-TJiq42uJaOPGBfPz91ULReQ1_ahXpUHNaJ8');

        // Функция для обновления подсказок

        function updateHint(hint, color) {
            var hints = document.getElementById("passwordHints");
            hints.innerHTML += `<span style="color: ${color}">&bull; ${hint}</span><br>`;
        }

        // Функция для проверки безопасности пароля и обновления шкалы

        function checkPasswordStrength() {
            var password = document.getElementById("password").value;
            var progressBar = document.getElementById("passwordStrength");
            var hintsContainer = document.getElementById("passwordHints");

            // Список условий
            var conditions = [
                { regex: /.{14,}/, hint: "Длина пароля должна быть не менее 14 символов", color: "#FF0000" },
                { regex: /[a-zа-я]/, hint: "Добавьте буквы нижнего регистра", color: "#FF0000" },
                { regex: /[A-ZА-Я]/, hint: "Добавьте буквы верхнего регистра", color: "#FF0000" },
                { regex: /\d/, hint: "Включите хотя бы одну цифру", color: "#FF0000" },
                { regex: /[$@#&!%^]/, hint: "Используйте спецсимволы для усиления пароля", color: "#FF0000" }
            ];

            // Перезаполняем подсказки при каждом вводе
            hintsContainer.innerHTML = "<strong style='color: #FFFFFF;'>Что нужно добавить в пароль:</strong><br>";

            var strength = conditions.length;

            conditions.forEach(function (condition) {
                if (password.match(condition.regex)) {
                    strength--;
                    updateHint(condition.hint, "#00FF00"); // Зелёный цвет, если условие выполнено
                } else {
                    updateHint(condition.hint, condition.color);
                }
            });

            // Обновление шкалы в зависимости от сложности пароля
            var width = (1 - strength / conditions.length) * 100;
            progressBar.style.width = width + "%";
            progressBar.style.backgroundColor = (width < 50) ? "#FF0000" : (width < 75) ? "#FFA500" : "#00FF00";


        }

        // Обработчик события на ввод пароля
        document.getElementById("password").addEventListener("input", checkPasswordStrength);

        function togglePasswordVisibility() {
            var Password = document.getElementById('password');
            var confirmPassword = document.getElementById('confirmPassword');
            var eyeIcon1 = document.getElementById('eyeIcon1');
            var eyeIcon2 = document.getElementById('eyeIcon2');


            if (Password.type === 'password') {
                Password.type = 'text';
                confirmPassword.type = 'text';
                eyeIcon1.innerHTML = '&#128064;';
                eyeIcon2.innerHTML = '&#128064;';
            } else {
                Password.type = 'password';
                confirmPassword.type = 'password';
                eyeIcon1.innerHTML = '&#128065;';
                eyeIcon2.innerHTML = '&#128065;';
            }
        }

        async function handleServerResponse(data) {
            isPhoneUsed = data.phone_used;
            isEmailUsed = data.email_used;

            if (isPhoneUsed && isEmailUsed) {
                phoneInput.style.borderColor = 'red';
                emailInput.style.borderColor = 'red';
                registrationButton.disabled = true;
                showPopupWithImageAndText(data.message, 'https://imgur.com/aHcCPrp.jpg', 5000);
            } else if (isPhoneUsed) {
                phoneInput.style.borderColor = 'red';
                emailInput.style.borderColor = '';
                registrationButton.disabled = true;
                showPopupWithImageAndText(data.message, 'https://imgur.com/aHcCPrp.jpg', 5000);
            } else if (isEmailUsed) {
                emailInput.style.borderColor = 'red';
                phoneInput.style.borderColor = '';
                registrationButton.disabled = true;
                showPopupWithImageAndText(data.message, 'https://imgur.com/aHcCPrp.jpg', 5000);
            } else {
                phoneInput.style.borderColor = '';
                emailInput.style.borderColor = '';
                passwordInput.disabled = true;
                confirmPasswordInput.disabled = true;
                registrationButton.disabled = false;
                showPopupWithImageAndText(`Ура! Осталось заполнить все данные и сохранить!`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                replaceFormFields();
            }
        }

        async function checkUsernameAvailability(username) {
            try {
                const { data, error } = await supabaseClient
                    .from('users_public_information')
                    .select('username')
                    .eq('username', username);

                if (error) {
                    console.error('Ошибка при проверке уникальности ника:', error.message);
                    return false;
                }

                return !data.length; // Возвращаем true, если ник уникален
            } catch (error) {
                console.error('Ошибка при выполнении запроса:', error.message);
                return false;
            }
        }

        function replaceFormFields() {
            showLoader();
            // Изменение заголовка формы
            document.querySelector('.form-title').textContent = 'Давайте знакомиться!';
            document.querySelector('.form-subtitle').textContent = 'Добро пожаловать в сообщество!';

            // Удаление существующих полей
            const form = document.getElementById('loginForm');
            form.innerHTML = ''; // Очищаем форму

            // Добавление новых полей
            form.innerHTML = `
                <form id="registrationForm" class="login-form">
                    <h2 class="form-title">Давайте знакомиться!</h2>
                    <p class="form-subtitle">Добро пожаловать в сообщество!</p>

                    <div class="input-container full-width">
                        <input type="text" id="firstName" name="firstName" placeholder="Имя" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '')" required>
                    </div>

                    <div class="input-container full-width">
                        <input type="text" id="lastName" name="lastName" placeholder="Фамилия" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '')" required>
                    </div>

                    <div class="input-container full-width">
                        <div class="nickname-container">
                            <input type="text" id="nickname" name="nickname" placeholder="Ник" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '')" required>
                            <span class="help-icon" onclick="showNicknameHelp()">?</span>
                        </div>
                    </div>

                    <div class="input-container full-width">
                        <div class="help-icon img_v"></div>
                        <select id="gender" name="gender" required>
                            <option value="0" disabled selected>Пол: Не указан</option>
                            <option value="1">Пол: Мужской</option>
                            <option value="2">Пол: Женский</option>
                        </select>
                    </div>

                    <div class="input-container full-width">
                        <input type="date" id="birthdate" name="birthdate" placeholder="Дата рождения" required>
                    </div>
                    <div id="turnstile-container"></div>
                    <button type="button" id="registerButton" onclick="saveProfile()">Зарегистрироваться</button>
                </form>
            `;

            renderCaptcha();

            hideLoader();

            // Функция для отображения помощи по нику

            window.showNicknameHelp = function() {
                alert('Ник - это ваш уникальный идентификатор в системе. Он будет использоваться для входа в систему, а также будет отображаться другим пользователям.');
            };

            // Слушатель событий на форму

            form.addEventListener('input', function(event) {
                if (event.target.id === 'nickname') { // Проверяем, изменилось ли поле с id "nickname"
                    clearTimeout(typingTimer); // Сбрасываем предыдущий таймер

                    const username = event.target.value.trim(); // Получаем значение поля

                    // Проверяем, что введён хотя бы один символ
                    if (username.length > 0) {
                        const inputField = document.getElementById('nickname');
                        inputField.style.backgroundColor = '#283040';
                        typingTimer = setTimeout(async function() {
                            const isAvailable = await checkUsernameAvailability(username); // Проверяем уникальность ника

                            // Подсвечиваем поле в зависимости от результата проверки
                            if (isAvailable) {
                                inputField.style.backgroundColor = 'lightgreen'; // Зелёный цвет для доступного ника
                            } else {
                                inputField.style.backgroundColor = 'lightcoral'; // Красный цвет для занятого ника
                            }
                        }, 2000); // Задержка в 3 секунды перед отправкой запроса
                    } else {
                        // Если поле ника пустое, сбрасываем стили
                        event.target.style.backgroundColor = '';
                    }
                }
            });
        }

        let widgetId;

        async function register() {
            phone = phoneInput.value.replace(/\s/g, '');
            email = emailInput.value;
            password = passwordInput.value;

            if (turnstile.isExpired(widgetId) || !captchaToken) {
                showPopupWithImageAndText('Мы конечно вам доверяем, но всё же необходимо пройти проверку, чтобы мы удостоверились, что вы не робот!', 'https://imgur.com/aHcCPrp.jpg', 5000);
                renderCaptcha();
                return;
            }

            showLoader();
            registrationButton.disabled = true;

            try {
                const response = await fetch('https://synask-server.vercel.app/check_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email, phone_number: phone })
                });

                const data = await response.json();

                hideLoader();

                if (response.ok) {
                    handleServerResponse(data);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error(error);
                showPopupWithImageAndText('Произошла ошибка при проверке данных. Пожалуйста, попробуйте еще раз.', 'https://www.freeiconspng.com/uploads/crossed-the-plate-png-transparent-image-error-sign-17.png', 5000);
                setTimeout(function() {
                    location.reload();
                }, 4000);
            }
        }

        document.getElementById('phone-num').addEventListener('input', () => {
            if (isPhoneUsed) {
                const registrationButton = document.getElementById('registration');
                registrationButton.disabled = true;
            }
        });

        document.getElementById('email').addEventListener('input', () => {
            if (isEmailUsed) {
                const registrationButton = document.getElementById('registration');
                registrationButton.disabled = true;
            }
        });

        // Сохранить профиль

        async function saveProfile() {
            const firstName = document.getElementById('firstName').value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '');
            const lastName = document.getElementById('lastName').value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '');
            const birthdate = document.getElementById('birthdate').value;
            const gender = document.getElementById('gender').value;
            const nickname = document.getElementById('nickname').value.replace(/(^[^a-zA-Z0-9а-яА-Я])|([^a-zA-Z0-9а-яА-Я]$)/g, '').replace(/[^\w.-]/g, '');
            const registerButton = document.getElementById('registerButton');
            onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9а-яА-Я]/g, '')"

            if (!firstName ||!lastName ||!birthdate ||!nickname) {
                showPopupWithImageAndText('Пожалуйста, заполните все поля.', 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Показываем уведомление о загрузке и блокируем кнопку сохранения
            showLoader();
            registerButton.disabled = true;

            const isAvailable = await checkUsernameAvailability(nickname); // Проверяем уникальность ника

            // Подсвечиваем поле в зависимости от результата проверки
            if (!isAvailable) {
                showPopupWithImageAndText('Пожалуйста, введите уникальный ник. Этот ник уже используется!', 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            try {
                let emailRedirectTo = 'https://me.synask.ru/check';

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        captchaToken: captchaToken,
                        emailRedirectTo: emailRedirectTo,
                        data: {
                            phone: phone,
                            firstName: firstName,
                            lastName: lastName,
                            birthday: birthdate,
                            gender: gender,
                            nickname: nickname
                        }
                    }
                });

                console.log(data);
                console.log(data.user.id);

                hideLoader();

                if (error) {
                    console.error('Ошибка при регистрации:', error.message);
                    showPopupWithImageAndText(`Произошло исключение при регистрации на стороне клиента.`, 'https://www.freeiconspng.com/uploads/crossed-the-plate-png-transparent-image-error-sign-17.png', 5000);
                    return;
                }

                // Если регистрация прошла успешно
                console.log('Пользователь успешно зарегистрирован');
                const modalContent = document.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <p style="color: white; text-align: center; font-size: 20px;">
                        Ваш аккаунт создан, но он недоступен для просмотра.
                        Чтобы полноценно зарегистрировать аккаунт, необходимо проследовать инструкциям в отправленном на указанную почту <strong>${email}</strong> письме.
                        <strong>Срок действия ссылки в письме - 24 часа.</strong>
                    </p>

                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <a href="https://mail.google.com" target="_blank">
                            <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/logo_gmail_lockup_default_1x_r5.png" alt="Gmail" style="width: 100px; margin: 0 10px;">
                        </a>
                        <a href="https://mail.ru" target="_blank">
                            <img src="https://img.imgsmail.ru/static.promo/logo/logo.svg" alt="Mail.ru" style="width: 100px; margin: 0 10px;">
                        </a>
                        <a href="https://mail.yandex.ru" target="_blank">
                            <img src="https://sun9-64.userapi.com/impg/XCNoN4K5w0SSGE0SYOXgPVmu1n5AcuddzijPFw/4YeOLSDWhHk.jpg?size=1200x459&quality=95&sign=418e83fde0ab19292bc3aeab68fe9df2&c_uniq_tag=3oh6wp53_hSsG1ZvstWzBotNZIiX93gNtowjLbuFSXQ&type=album" alt="Yandex Mail" style="width: 100px; margin: 0 10px;">
                        </a>
                    </div>
                `;
                openModal()
            } catch (error) {
                console.error('Ошибка при регистрации:', error.message);
                showPopupWithImageAndText(`Произошло исключение при регистрации на стороне клиента.`, 'https://www.freeiconspng.com/uploads/crossed-the-plate-png-transparent-image-error-sign-17.png', 5000);
                closeModal();
            }
        }

        // Открыть модальное окно

        function openModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'block';
        }

        // Закрыть модальное окно

        function closeModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'none';
        }

        // Функция для проверки всех полей и активации кнопки регистрации

        async function checkFormValidity() {
            phone = document.getElementById('phone-num').value.replace(/\s/g, '');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const registrationButton = document.getElementById("registration");
            registrationButton.disabled = true;

            // Проверка наличия значений во всех полях
            if (phone.trim() === '' || email.trim() === '' || password.trim() === '' || confirmPassword.trim() === '') {
                showPopupWithImageAndText(`Заполните все поля.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Проверка верности номера телефона
            const phoneRegex = /^\+\d{1,3}\s?\d{3}\s?\d{3}\s?\d{2}\s?\d{2}$/;
            if (!phoneRegex.test(phone)) {
                showPopupWithImageAndText(`Неверный формат номера телефона.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Проверка верности адреса электронной почты
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showPopupWithImageAndText(`Неверный формат адреса электронной почты.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Проверка требований к паролю
            const passwordRegex = /^(?=.*\d)(?=.*[a-zа-я])(?=.*[A-ZА-Я])(?=.*[$@#&!%^]).{14,}$/;
            if (!passwordRegex.test(password)) {
                showPopupWithImageAndText(`Пароль не соответствует требованиям.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Проверка совпадения паролей
            if (password !== confirmPassword) {
                showPopupWithImageAndText(`Пароли не совпадают.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
                return;
            }

            // Если все проверки пройдены успешно, активируем кнопку регистрации
            showPopupWithImageAndText(`Теперь все данные в верном формате!.`, 'https://imgur.com/aHcCPrp.jpg', 5000);
            registrationButton.disabled = false;
        }

        // Добавление обработчиков событий на изменение полей ввода
        document.getElementById('phone-num').addEventListener('input', checkFormValidity);
        document.getElementById('email').addEventListener('input', checkFormValidity);
        document.getElementById('password').addEventListener('input', checkFormValidity);
        document.getElementById('confirmPassword').addEventListener('input', checkFormValidity);

        const emailInUrl = urlParams.get('email');

        hideLoader();

        if (emailInUrl) {
            const emailInput = document.getElementById('email');
            emailInput.value = emailInUrl;
        }
    </script>
</body>
</html>